\documentclass{article}
\usepackage{algpseudocode,amsfonts,easylist,amssymb,amsmath,sectsty,url,enumitem}
\usepackage[letterpaper,hmargin=.75in,vmargin=.75in]{geometry}
\usepackage{authblk}
%\usepackage[]{algorithm2e}
\newcommand{\tcpa}{$(t,\eps)$-Ind-CPA}
\def\B{{\sf B}}
\def\A{{\sf A}}
\def\E{{\sf Enc}}
\def\D{{\cal D}}
\def\a{${\mathcal D}$}
\def\ch{${\mathcal C}$}
\newcommand{\encrypt}{{\sf encrypt}}
\newcommand{\game}{{\sf Game}}
\newcommand{\dgame}{{\mathbf{Game}}}
\newcommand{\T}{{\mathsf T}}
\newcommand{\dgg}[2]{\game_{#1}^{#2}}
\newcommand{\dgb}[2]{\game_{\cub{#1}}^{\cub{#2}}}
\newcommand{\real}{{\mathsf {real}}}
\newcommand{\fake}{{\mathsf {fake}}}
\newcommand{\lastup}{{\mathsf {LastUp}}}
\newcommand{\lastdown}{{\mathsf {LastDown}}}
\newcommand{\NN}{{\mathbb{N}}}
\newcommand{\gpi}{$\game^P_I$}
\def\corrupt{{\sf corrupt}}
\def\challenge{{\sf challenge}}
\def\aout{\mathsf A_{out}}
\def\vaa{0}
\def\newver{1}
\newcommand{\qF}[2]{\left[ (p_{#1},p_{#2}), \fake\right]}
\newcommand{\qR}[2]{\left[ (p_{#1},p_{#2}), \real\right]}
\renewcommand{\labelitemi}{$-$}
\renewcommand{\labelitemii}{$\diamond$}
\renewcommand{\labelitemiii}{$\ast$}
\renewcommand{\labelitemiv}{$\bullet$}
\newcommand{\dT}{{\mathsf{T}}}
\newcommand{\bigv}[1]{\mbox{\large $v_{#1}$}}
\newcommand{\bigt}[1]{{\dT}^{({#1})}}
\newcommand{\bigtb}[1]{\tilde{\dT}^{({#1})}}
\newcommand{\bigw}{\mbox{\large $w$}}
%\def\null{{\sf null}}

\input{preamble.tex}
\begin{document}

\title{}
\author{}
%\affil{Northeastern University\\\small{\texttt{\{zahra\}@ccs.neu.edu }}}

%\affil{Northeastern University }
\maketitle

\def \cF {\F}

\begin{abstract}
\end{abstract}

\section{Introduction}
\section{Preliminaries}

For $a\in \NN$, we let $[a]=\cub{1,2, \cdots, a}$ and $[a]_0=[a]\cup \cub{0}$. We say adversary (or distinguisher) \a~is $t$-bounded if \a~runs in time $t$.% We denote a t-bounded adversary with the subscript $t$; $\mathcal{A}_t$.

\begin{definition}\textbf{(Indistinguishability)}. Two distributions $X$ and $Y$ are $(\eps,t)$-indistinguishable, denoted $Y \sim_{(\eps,t)} X$ or $\Delta_{t}(Y,X)\leq \eps$, if  no $t$-bounded distinguisher \a~can distinguish them with advantage greater than $\eps$, i.e., \[ \Delta_{t}(Y,X)\leq \eps \Longleftrightarrow \forall \mathcal{A}_t : \abs{\prob{\mathcal{A}_t(X)=1}-\prob{\mathcal{A}_t(Y)=1} }\leq \eps. \]
\end{definition}

Let $(\Enc,\Dec)$ be a symmetric-key encryption scheme. Consider a game between a challenger \ch~and a distinguisher \a. \ch~chooses a uniformly random key $k\in \zo^\lambda$, where $\lambda$ is the security parameter, and a bit $b$. \a~can send queries of form $(m_0,m_1)$ to \ch, and receives $c\leftarrow \Enc_k(m_b)$ from \ch. To receive the encryption of a specific message $m$, \a~can query $(m,m)$. In the end, \a~will output a bit $\tilde{b}\in \zo$. 

\begin{definition} Let $t \in \NN^+$ and $0<\eps <1$. An encryption scheme $(\Enc,\Dec)$ is \tcpa~secure encryption scheme if for any $t$-bounded distinguisher \a, we have $$\abs{\prob{\mathcal{D}_t^{\mathcal{C}[k,b]}=1|b=0} - \prob{\mathcal{D}_t^{\mathcal{C}[k,b]}=1|b=1} }\leq \eps.$$
\end{definition}

\section{The GSD game}
In this section we describe the generalized selective decryption game as it appears in [Panjwani07] and give our main theorem. \iffalse which improves on the result of previous work in many cases... \fi  Consider the following game, called the generalized selective decryption
(GSD) game, played by two players \A~(also referred to as the adversary) and \B, both being given blackbox access to a symmetric-key encryption scheme $(\Enc,\Dec)$. The game is parameterized by an integer $n$, assumed to be known to both \A~and \B. In the beginning, \B~generates a set of keys, $k_1, k_2, \cdots, k_n$, each key being sampled independently and uniformly at random from the set $\zo^\lambda$ (where $\lambda$ is the security parameter). \B~also chooses a challenge bit $b $, uniformly at random from $\zo$, which \A~is required to guess in the end. \B~stores the generated values for the rest of the game, and uses them to answer all of \A's queries. \A~can make three types of queries to \B:
\begin{itemize}
\item \encrypt: At any point, \A~can make a query of the form \encrypt$(i, j)$, in
response to which \B~creates a ciphertext $c=\Enc_{k_i} (k_j)$ (using fresh coins for the encryption operation each time) and returns $c$ to \A.
\item \corrupt: \A~can also ask for the value of any key initially generated by \B; it does this by issuing a query of the form $\corrupt(i)$, in response to which it receives $k_i$.
\item \challenge: Finally, \A~can issue a query of the form \challenge$(i)$. The response for such a query is decided based on the bit $b$: if $b = 0$, \B~returns the key $k_i$ to \A, whereas if $b = 1$, it generates a value $r_i$ uniformly at random
from $\zo^\lambda$, and sends $r_i$ to \A.
\end{itemize}
Multiple queries of each type can be made, interleavingly and adaptively. Note that \A~can make more than one challenge query in the game and it can choose to interleave
its challenge queries with the other two types of queries. Giving the adversary the power to make multiple
challenge queries, models the requirement that keys linked with challenge nodes be jointly     
pseudorandom (as opposed to individual keys being pseudorandom by themselves). Allowing it
to interleave challenges with other queries means that such keys are required to retain their
pseudorandomness even after more corruptions or ciphertext transmissions have occurred.

We think of the queries of \A~as creating a directed graph over $n$ nodes (labeled $1, 2,\cdots, n)$,
edge by edge, and in an adaptive fashion. Each query $\encrypt(i, j)$ corresponds to creating an
edge from $i$ to $j$, denoted $(i,j)$, in this graph. For any player  \A, the graph created by its
queries in this manner is called the key graph generated by \A~and is denoted $G(\A)$. A node $i$
in $G(\A)$ for which \A~issues a query $\corrupt(i)$ is called a corrupt node while one for which \A~issues a query $\challenge(i)$ is referred to as a challenge node. The set of all corrupt nodes is
denoted $V^{corr}(\A)$ and that of all challenge nodes is denoted $V^{chal}(\A)$. Note that $G(\A)$, $V^{corr}(\A)$
and $V^{chal}(\A)$ are all random variables depending on the coins used by both \A~and \B. Without
loss of generality, we assume that $V^{chal}(\A)$ is always non-empty and in any execution of \A, every node $i\in V^{chal}(\A)$ has at least one edge incident upon it. (Put differently, this means that \A~always makes at least one query of the form $\challenge(i)$ and for each such query, it makes at least one query of the form $\encrypt(x, i)$.)\\

  \textbf{Legitimate Adversaries.} There is a trivial way in which any adversary can win in the GSD game—by corrupting a node  $i$ in $G(\A)$ and making a query $\challenge(j)$ for any $j$ that is
reachable from $i$, \A~can easily compute the challenge bit $b$. The interesting case to consider is,
thus, one in which \A~is constrained not to issue queries of this form, that is, where \A~is restricted
to make queries in a manner such that no challenge node is reachable from a corrupt node in
$G(\A)$.
Our intuition suggests that if the encryption scheme is secure (in the Ind-CPA sense), then
the chances of such an adversary being able to decipher $b$ correctly are no better than half.
However, translating this intuition into a proof is far from easy. For one, it is not even possible
to do this without further restrictions on the adversary’s queries: if a key $k_j$ is used to encrypt
other keys (that is, there exists an edge issuing from $j$ in $G(\A)$), then $k_j$ cannot be guaranteed
to remain pseudorandom, even if $j$ is not reachable from the corrupt nodes. In other words, we
can hope to prove pseudorandomness of keys associated with challenge nodes only as long as
these nodes have no outgoing edge in $G(\A)$. Secondly, arguing about the security of encryption
schemes in the presence of key cycles is a gruelingly hard problem; in particular, it is currently
not known whether an arbitrary Ind-CPA-secure encryption scheme can be proved to retain its
security in a situation where ciphertexts of the form $\Enc_{k_1}(k_2), \Enc_{k_2}(k_3),\cdots, \Enc_{k_{t−1}}(k_t), \Enc_{k_t}(k_1)$, for
some $t >1$, are created using it. Standard techniques do not allow to prove such statements
and counterexamples are not known either. Given this state of affairs, our only hope to prove
security in the GSD game is to forbid the creation of key cycles altogether.
We formalize all our requirements from the adversary in the following definition:

\begin{definition} An adversary $\A$ is called legitimate if in any execution of $\A$ in the GSD game,
the values of $G(\A)$, $V^{corr}(\A)$ and $V^{chal}(\A)$ are such that:
\begin{itemize}
\item For any $i \in V^{corr}(\A)$ and any $j \in V^{chal}(\A)$, $j$ is unreachable from $i$ in $G(\A)$.
\item $G(\A)$ is a DAG and every node in $V^{chal}(\A)$ is a sink in this DAG.
\end{itemize}
\end{definition}

Let \A~be any legitimate adversary playing the GSD game and let $\G$ be a class of directed acyclic graphs. We say that \A~is a $\G$-adversary if in any execution, the key graph generated by \A~belongs to $\G$. We denote the random variable corresponding to the output
of $\A$ in the game by $A^{B^{(\Enc,\Dec)}_b}$. In this paper we consider $\G$ which only contain directed trees.  

\begin{definition} Let $t \in \NN^+$, $0 < \eps < 1$. An encryption scheme $(\Enc,\Dec)$ is called $(t,\eps, \G)$-GSD secure if for every legitimate $\G$-adversary \A~running in time $t$, we have
$$\abs{\prob{\A^{\B^{(\Enc,\Dec)}_b}=1|b=1}-\prob{\A^{\B^{(\Enc,\Dec)}_b}=1|b=0}}\leq \eps.$$
\end{definition}

\begin{theorem}\label{thm:main}
Let $t \in \NN^+$, $0 < \eps < 1$ and $\G$ be a class of directed trees. If an encryption scheme is \tcpa~secure, then it is also $(t',\eps',\G)$-GSD secure when $\G$ is the class of directed trees of $n$ nodes,

\begin{itemize}
\item$\eps'=\eps \cdot n \cdot \rob {(2n+1)\cdot n}^{\log n}$.
\item and if the maximum outdegree of any node in a tree in $\G$ is at most $d$, then $\eps'=\eps \cdot n \cdot \rob {(2d+1)\cdot n}^{\log n}$.
\item and if any tree in $\G$ is of depth at most $\ell$ and has at most $s$ sources, then $\eps'=\eps \cdot n \cdot \rob {(2n+1)\cdot n}^{\log s} \rob {3n}^{\log \ell} $.
\item and if any tree in $\G$ is of depth at most $\ell$ and has at most $s$ sources, and outdegree at most $d$ then $\eps'=\eps \cdot n \cdot \rob {(2d+1)\cdot n}^{\log s} \rob {3n}^{\log \ell} $.

\end{itemize} 
\end{theorem}

\section{Single path} %inderee one, outdegree one. 

In this section, we begin with studying a simplified case. Assume we know the graph constructed during the GSD game is a single path from some node $v_1$ to some challenge node $v_n$. Since all the nodes are on the path to the challenge, a legitimate adversary cannot corrupt any nodes. Furthermore there cannot be more than one challenge, for there is only one sink. 

\begin{theorem}\label{thm:s1in-1out}
Let $t \in \mathbb{N}$, $0<\eps<1$ and $\G_1$ a class of directed trees. If an encryption scheme is \tcpa~secure, then it is also $(t',\eps',\G_1)$-GSD secure for $\eps'=(3n)^{\log n} \eps $ and $t'=t-O(Time(\Enc))$ where $\G_1$ contains graphs of $n$ nodes which create a single path from a source node to a sink.
\end{theorem}

  \textbf{Notation.} We introduce a few notations that will help us with the description of games we use in our proofs. A \textit{real} response to a query \encrypt$(x,y)$ is $c\leftarrow \Enc_{k_x}(k_{y})$ and a \textit{fake} response to the same query is sampled from $\Enc_{k_x}(r_{y})$, where $r_y$ is independently and uniformly chosen from $\zo^\lambda$ for all $y\in [n]$. Similarly a real response to a query \challenge$(z)$ is $k_z$ and a fake response is $r_z$. We use a game's name to represent the output distribution of that game. For example, $\dgame$ is a random variable in $\zo$, distributed according to the output of the game called $\dgame$. Also we use the term ``guess" to describe an independent and uniform sampling from a set.\\

  \textbf{The simplified game.} The single path game is defined as follows, $\game_b$: \B~chooses $n$ keys $k_1,k_2,\cdots,k_n$ uniformly and independently from $\zo^\lambda$. Each key is identified by its index in $[n]$. In addition to these keys, \B~also samples \textit{fake} keys $r_i$ uniformly and independently from $\zo^\lambda$ for each $i\in [n]$. \A~asks $n-1$ queries of the form \encrypt$(x,y)$ and one query of the form \challenge$(z)$, where $x,y$ and $z$ are all indices of the keys. These queries create the path $(p_1,p_2,\cdots, p_n)$ where each $p_i$ (index of a key) appears only once.  \B~returns real responses to all \encrypt~queries and if $b=0$ the response to the challenge query is the real answer ($k_{z}$) as well, and otherwise it is the fake one $r_{z}$. In the end, \A~outputs a bit in $\zo$. The output of the game is $\A$'s output. If the encryption scheme $(\Enc,\Dec)$ is not $(t',\eps',\G_1)$-GSD secure then there exists a player \A~running in time $t'$ such that
$\abs{\prob{\game_0=1}-\prob{\game_1=1}}> \eps'.$
Meaning $\game_0$ and $\game_1$ are $(t',\eps')$-distinguishable. Our goal is to show that this will contradict the \tcpa~security of the encryption scheme. \\

  \textbf{A small reduction.} Our first step is to define two games $\game_{\emptyset}$ and $\game_{\{n\}}$ which we will show they have the following property 
\[\abs{\prob{\game_{\emptyset}=1}-\prob{\game_{\{n\}}=1}}=\abs{\prob{\game_0=1}-\prob{\game_1=1}}/n. \]
  So we can use the new assumption $\abs{\prob{\game_{\emptyset}=1}-\prob{\game_{\{n\}}=1}} > \eps'/n$ to break the \tcpa~security of the encryption scheme. Both new games have an extra step at the beginning of the game: $\B$ guesses which key is going to be the challenge key and at the end of the game only if $\B$'s guess was correct, the output of the game is $\A$'s output and otherwise it is 0. Clearly $\B$ is correct with probability $1/n$. Aside from this guessing step, $\game_{\emptyset}$ is identical to $\game_0$; all responses are real. Therefore $\prob{\game_{\emptyset}=1}= \prob{\game_0=1}/n$. On the other hand, $\game_{\{n\}}$ is identical to $\game_1$ except for the query that is to be replied with a fake answer. In $\game_{\{n\}}$ the challenge query is replied honestly but the query that asks for the encryption of the (guessed) challenge key is responded with a fake answer. If we show that the view of the adversary is the same in both $\game_1$ and $\game_{\{n\}}$ when the challenge is guessed correctly, then we can use the new assumption instead of the old one. Let $\challenge(z)$ and $\encrypt(y,z)$ be the queries responded with different answers in the two games.  In $\game_{1}$, $\A$ receives $r_z$ and $\Enc_{k_{y}}(k_z)$, while in $\game_{\cub{n}}$, $\A$ receives $k_z$ and $\Enc_{k_y}(r_z)$. But note that $r_z$ and $k_z$ are distributed identically and independently from each other and neither of them will be used anywhere else in the game. Therefore the two distributions $(r_z,\Enc_{k{y}}(k_z))$ and $(k_z,\Enc_{k{y}}(r_z))$ are the same conditioned on $z$ being the correct challenge key, which happens with probability $1/n$. Thus $\prob{\game_{\{n\}}=1}= \prob{\game_1=1}/n$. Next we show that if $\game_{\emptyset}$ and $\game_{\cub{n}}$ are $(t',\eps'/n)$-distinguishable then there are two games $(\dgame$ and $\dgame')$ that are $(t,\eps)$-distinguishable and their distinguishablity implies that $(\Enc,\Dec)$ is not \tcpa~secure.\\ 

To break Ind-CPA security of $(\Enc,\Dec)$ we need to construct an distinguisher \a~that can distinguish between encryption of two different messages under a uniformly random key, with non-negligible probability. So the game is as follows: \a~chooses two messages $m_1$ and $m_0$ and gets a ciphertext $c\leftarrow \Enc_k(m_b)$ back and outputs $\tilde{b}$. The encryption scheme is not secure if \a~runs in time $t$ and
\[\abs{\prob{{\mathcal D}_{t}^{\mathcal{C}[k,b]}=1|b=1}-\prob{{\mathcal D}_{t}^{\mathcal{C}[k,b]}=1|b=0}}>\eps.\]
Intuitively, we like to find two games such that they only differ in the response distribution of one query. Let's  call this query \encrypt$(y,z)$, which is responded to with a real ciphertext in $\dgame$ and with a fake ciphertext in $\dgame'$. This way the adversary that distinguishes these two games with probability higher than $\eps$, can distinguish between $\Enc_{k_y}(k_z)$and $\Enc_{k_y}(r_z)$. So far it seems like even the two games $\game_{\emptyset}$ and $\game_{\cub{n}}$ should be enough to construct distinguisher \a. However we need the encryption key to be uniformly and independently random. But $\A$ can query $\encrypt(x,y)$ for some $x \in [n]$. To ensure that $k_y$ looks uniform and independent to $\A$ (and consequently to distinguisher \a), we add another requirement to the games that we are looking for. Namely the query \encrypt$(x,y)$ is responded to with a fake ciphertext in both games, i.e. $c \leftarrow \Enc_{k_x}(r_y)$. This way $k_y$ remains independent and uniform. \\

  In short, we are going to show that there are two games $\dgame$ and $\dgame'$, which are $(t,\eps)$-distinguishable if $\game_{\emptyset}$ and $\game_{\cub{n}}$ are $(t',\eps'/n)$-distinguishable and have the following two properties which will enable us to derive the contradiction. 
\if\vaa1
\begin{enumerate}[Property 1.]
 \item $\dgame$ and $\dgame'$ are identical except for the response to one query $\encrypt(y,z)$, which is replied to with a real ciphertext in $\dgame$ and a fake one in $\dgame'$.
 \item Query $\encrypt(x,y)$ is replied to with a fake response in both game.
 \end{enumerate}
 \else
 \renewcommand{\labelitemi}{$\diamond$}
 \begin{itemize}
 \item Property 1. $\dgame$ and $\dgame'$ are identical except for the response to one query $\encrypt(y,z)$, which is replied to with a real ciphertext in $\dgame$ and a fake one in $\dgame'$.
 \item  Property 2. Query $\encrypt(x,y)$ is replied to with a fake response in both game.
\end{itemize}
 \fi
 As a first attempt to find the two games, we consider the following games $G_1, G_2, \cdots, G_{2n}$ where $[(x,y), {\mathsf{fake/real}}]$ indicates that the query $\encrypt(x,y)$ was made and according to the rules of the game, it was responded to with a fake or real ciphertext. The challenge query is always replied to with a real key. 
\renewcommand{\labelitemi}{$-$}
 \begin{itemize}
\item $G_1$:$\qR{1}{2},\qR{2}{3}, \cdots,\qR{n-2}{n-1},\qR{n-1}{n}$.
\item $G_2$:$\qF{1}{2},\qR{2}{3}, \cdots,\qR{n-2}{n-1},\qR{n-1}{n}$.\\
 \vdots
\item $G_{n-1}$:$\qF{1}{2},\qF{2}{3}, \cdots,\qF{n-2}{n-1},\qR{n-1}{n}$.
\item $G_{n}$:$\qF{1}{2},\qF{2}{3}, \cdots,\qF{n-2}{n-1},\qF{n-1}{n}$.
\item $G_{n+1}$:$\qF{1}{2},\qF{2}{3}, \cdots,\qR{n-2}{n-1},\qF{n-1}{n}$.\\
 \vdots
\item $G_{2n-1}$:$\qF{1}{2},\qR{2}{3}, \cdots,\qR{n-2}{n-1},\qF{n-1}{n}$.
\item $G_{2n}$:$\qR{1}{2},\qR{2}{3}, \cdots,\qR{n-2}{n-1},\qF{n-1}{n}$.
 \end{itemize}

  Clearly $G_1 \sim \game_{\emptyset}$ and $G_{2n}\sim\game_{\cub{n}}$. Moreover every two games $G_i$ and $G_{i+1}$ have the properties that we are looking for in games $\dgame$ and $\dgame'$. Now one might hope to conclude that if $G_1$ and $G_{2n}$ are $\eps'/n$-distinguishable then there must be two games $G_i$ and $G_{i+1}$ such that they are $(t',\eps'/n(2n-1))$-distinguishable. What is missing is that we do not know the path from $p_1$ to $p_n$. The adversary chooses its queries arbitrarily and we cannot decide which query is at which step of the path to the challenge. The naive approach to solve this problem is to guess the entire path at the beginning of the game and then play the game as if we knew the path. In the end if the guesses were correct, the output of the game is the output of $\A$ and if not it is 0. We are correct with exponentially low probability and consequently the non-negligible $\eps'$ will most likely give us a negligible $\eps= \eps'/O(n!)$. In our approach we avoid this exponential loss by guessing the path gradually.\\

  \textbf{An example}. Assume $n$ is a power of 2 and consider $\game^{\{n/2\}}_{\emptyset}$ which is identical to $\game_{\emptyset}$, except that in addition to the challenge node, \B~also guesses which node ($x\in [n]$) is going to be the node in the middle of the path to the challenge, i.e. $p_{n/2}=x$ (hence the superscript $\{n/2\}$). Then the game continues as before and the output of $\dgg{\emptyset}{\{n/2\}}$ is \A's output if the guess was correct and 0 otherwise. Since \B~guesses correctly with probability $1/n$, we have 
\[\prob{\dgg{\emptyset}{\cub{n/2}}=1}= \prob{\game_{\emptyset}=1}/n.\]
  By guessing the middle node, we can assume the middle node is \textit{known} and this will enable us define the hybrid game in which the query for the encryption of $k_{p_{n/2}}$ is responded to with a fake answer, $\dgb{n/2}{n/2}$. The subscript shows the nodes on the path which correspond to fake responses in the game. Recall that our goal is to find the two games $\dgame$ and $\dgame'$, so we want games that are identical except for the answer to one query. In addition to these games, consider two games $\dgb{n/2,n}{n/2}$ and $\dgb{n}{n/2}$ which are similarly defined by making the same changes to game $\game_{\{n\}}$, i.e. guessing the middle node and replying to the encryption query  of the guessed key with a fake and a real ciphertext respectively. Once again we have, $\prob{\dgb{n}{n/2}=1}= \prob{\game_{\{n\}}=1}/n$. Therefore $(t',\eps'/n)$-distinguishablity of $\game_{\emptyset}$ and $\game_{\{n\}}$ implies that $\dgg{\emptyset}{\cub{n/2}}$ and $\dgb{n}{n/2}$ are $(t',\eps'/n^2)$-distinguishable, i.e. $\dElta{\dgg{\emptyset}{\cub{n/2}},\dgb{n}{n/2}} > \eps'/n^2.$
\begin{align}
\dElta{\dgg{\emptyset}{\cub{n/2}}, \dgb{n/2}{n/2}} + \dElta{ \dgb{n/2}{n/2},\dgb{n/2,n}{n/2}} + \dElta{ \dgb{n/2,n}{n/2}, \dgb{n}{n/2}} \geq \nonumber \\ \dElta{\dgg{\emptyset}{\cub{n/2}},\dgb{n}{n/2}} > \nonumber \\ \eps'/n^2 \label{3.2} 
\end{align}
By inequality \ref{3.2}, at least one of the pairs of games is going to be $(t',\eps'/3n^2)$-distinguishable. Every pair of games differ in exactly one point, which is easy to spot looking at the subscript of each game. For instance, the differentiating point in $\dgb{n/2,n}{n/2}$ and $\dgb{n}{n/2}$ is node $n/2$. For each pair of games, the guessed node cuts the path to the challenge in half, one half is identical in both games and the other half, ends with the differentiating point. Regardless of which pair of games is actually the most distinguishable, we can repeat the same process on the half of the path which ends with the differentiating query, ignoring the identical half of the path. For example, for games $\dgb{n/2,n}{n/2}$ and $\dgb{n}{n/2}$ we repeat the process of guessing the middle point and replacing the real answer with a fake one for the first half of the path, i.e., we guess node $p_{n/4}$ and so on. At each guessing step we lose a factor of $n$ and at each \textit{halving} step, where we move to the next guessing step, we lose a factor of $3$. We recursively repeat these two steps until every pair of games that differ in exactly one query (satisfying property 1) also satisfy property 2. \\

  \textbf{The intuition.} Informally, we had two distinguishable games and we wanted to say that some non-negligible amount of the distinguishing power of the adversary comes from a single step in the two games. And we want to find that step. The common method to do this, is to define hybrid games differing in one step. This would allow us to pinpoint the step which is distinguishable. But we have two problems, one: we do not know which step is taken at every moment, and two: there are too many steps to guess them all! So we defined two games which are ``less'' distinguishable than the first two games, but one step is ``fixed" so we could define other hybrid games which at least two of them are still non-negligibly distinguishable. The other positive result is that now the distinguishing power of the adversary must lay in a smaller set of steps, so we have reduced the original problem into a smaller one. \\
\if\vaa1

\begin{enumerate}[Step 1.]
\item Guessing a node in the middle of the path: \begin{itemize} \item Allows us to define hybrid games which differ in one step, i.e. games that satisfy property 1. \item We lose a factor of $n$ in the distinguishing advantage. \end{itemize}
\item Pick a pair of games defined in Step 1 as the pair which is most distinguishable: \begin{itemize} \item We lose a factor of 3 in the distinguishing advantage. \item  Which specific pair of games is picked, is not important. What matters is that one of the pairs is non-negligibly distinguishable. That is enough to be able to proceed. \item The length of the path which contains the distinguishable step is reduced to half of what it was before. This helps us in eventually finding the games that satisfy property 2.
\end{itemize}
\end{enumerate}
\else

\begin{itemize}
\item Step 1. Guessing a node in the middle of the path: \begin{itemize} \item Allows us to define hybrid games which differ in one step, i.e. games that satisfy property 1. \item We lose a factor of $n$ in the distinguishing advantage. \end{itemize}
\item Step 2. Pick a pair of games defined in Step 1 as the pair which is most distinguishable: \begin{itemize} \item We lose a factor of 3 in the distinguishing advantage. \item  Which specific pair of games is picked, is not important. What matters is that one of the pairs is non-negligibly distinguishable. That is enough to be able to proceed. \item The length of the path which contains the distinguishable step is reduced to half of what it was before. This helps us in eventually finding the games that satisfy property 2.
\end{itemize}
\end{itemize}
\fi
\textbf{The hybrid games.} To explain our method in details, we define a series of games, $\dgg{I}{P}$. The difference in these games is in the nodes on the path that are guessed and also the nodes where the real answer is replaced with a fake one. In all these games the challenge query is responded to with a real answer and the fake responses are a subset of guessed nodes (including the challenge node) on the path. 

\begin{itemize}
\item The $\game$ is similar to the simplified game. \B~chooses $2n$ keys $k_1,r_1,k_2,r_2\cdots,k_n,r_n$ uniformly and independently from $\zo^\lambda$. Each real and fake key is identified by its index in $[n]$. \A~asks $n-1$ queries of the form \encrypt$(x,y)$ and one query of the form \challenge$(z)$, where $x,y$ and $z$ are all indices of the keys. These queries create the path $(p_1,p_2,\cdots, p_n)$. In the end \A~outputs a bit in $\zo$.
 
\item $P$ is a subset of integers in $[n]$ and always includes element $n$ (we omit writing $n$ in $P$ since it is always in $P$). The elements in $P$ determine the positions on the path that are going to be guessed by \B. For example, if $4\in P$, \B~will guess the node $v\in [n]$  which will be the 4th node on the path to the challenge. For every $i \in P$ let $v_i$ be the node guessed for the $i$th position. Clearly \B~can only know if these guesses were made correctly at the end of the game. If any of these guesses is wrong, the output of the game is $0$ and the game ends. In other words, $\dgg{I}{P}=0$ unless for all $i\in P$, $p_i=v_i$.

\item $I$ is a subset of $P$. The elements in $I$ determine the distribution of \B's responses to queries of \A.
\begin{itemize}
\item \encrypt~query: If $i\in I$, \encrypt$(x,v_i)=\Enc_{k_x}(r_{v_i})$, otherwise \encrypt$(x,v_i)=\Enc_{k_x}(k_{v_i})$. In other words, if $i\in I$, then the query requesting the encryption of $v_i$ is returned with a fake response.
\item \challenge~query: \challenge$(v_i)=k_{v_i}$. The challenge query is always replied honestly. 
\end{itemize}
\end{itemize}

We start with $P:=\{n\}$ and $I=\emptyset$ and $I'=\{n\}$. Adding an element $x$ to $P$ means we have taken Step 1, (losing a factor $n$) and so we can define two other hybrids by adding $x$ to $I$ and $I'$. Now we have 4 games, which make up 3 pairs, each pair differing in one step. Hence we know one pair is at least $\eps/3n^2$ distinguishable (Step 2) and we can repeat from step 1, with the distinguishable pair of games. We continue this process until the length of the distinguishable path is 1. This means we have found $\dgame$ and $\dgame'$. Since every round cuts the size of the distinguishable path to half, we only need to repeat these two steps $\log(n)$ times. 

\begin{lemma}\label{lem:single}
Let $P\subset [n], I \subset P, n\in P$ and $x\in P\setminus I$. Also let $y$ be the largest number in $I$ such that $y < x$, and $y=1$ if  $x$ is smaller than all elements in $I$. If $\dgg{I}{P}$ and $\dgg{I\cup \{x\}}{P}$ are $(t,\eps)$-distinguishable then 
\if\newver0
\begin{itemize}
\item If $x=y+1$, then $(\Enc,\Dec)$ is not \tcpa-secure.
\item If $x>y+1$, then for $x'=y+\lfloor{(x-y)/2}\rfloor$, $P'=P\cup \{x'\}$ and for some $I', I'' \subset P'$, $\abs{I'\Delta I''} =1$, $\dgg{I'}{P'}$ and $\dgg{I''}{P'}$ are $(t, \eps/3n)$-distinguishable.
\end{itemize}
\end{lemma}

\begin{proof}
If $x=y+1$ then $\dgg{I}{P}$ and $\dgg{I\cup \{x\}}{P}$ satisfy Properties 1 and 2. Therefore we can construct distinguisher \a~that breaks  the \tcpa~security of the encryption scheme. In both games $\encrypt(p_{y-1},p_{y})$ is responded to with a fake answer $\Enc_{k_{p_{y-1}}}(r_{p_{y}})$, thus $k_{p_{y}} $ remains independent and uniform in the eyes of the adversary. On the other hand the query $\encrypt(p_{y},p_x)$ is responded to with a fake answer $\Enc_{k_{p_{y}}}(r_{p_{x}})$ in one game and with a real answer in the other game, i.e. $\Enc_{k_{p_{y}}}(k_{p_{x}})$. Therefore if $\A$ can distinguish the two games, it can distinguish between the encryption of two messages, $r_x$ and $k_x$, under a uniform and independent key, $k_y$. 

If $x>y+1$, then the $x'$th node is roughly in the middle of $y$th and $x$th node on the path. If $\dgg{I}{P}$ and $\dgg{I\cup \{x\}}{P}$ are $(t,\eps)$-distinguishable then the two games  $\dgg{I}{P'}$ and $\dgg{I\cup {x}}{P'}$ are $(t,\eps/n)$-distinguishable, since the guess for the $x'$th node is correct with probability 1/n.
Now let $I_1=I$, $I_2=I\cup \{x'\}$, $I_3=I\cup \{x,x'\}$ and $I_4=I\cup \{x\}$, we have
\begin{align}
\dElta{\dgg{I_1}{P'}, \dgg{I_4}{P'}}  > \eps/n \\
\dElta{\dgg{I_1}{P'}, \dgg{I_2}{P'}} + \dElta{\dgg{I_2}{P'}, \dgg{I_3}{P'}} + \dElta{\dgg{I_3}{P'}, \dgg{I_4}{P'}}  \geq \nonumber\\ \dElta{\dgg{I_1}{P'}, \dgg{I_4}{P'}}  > \nonumber \\ \eps/n.
\end{align}

And therefore at least one of the above pairs of games is $(t,\eps/3n)$-distinguishable. \\
\end{proof}

\else

\begin{itemize}
\item If $x=y+1$, then $(\Enc,\Dec)$ is not \tcpa-secure.
\item If $x>y+1$, define $x'=y+\lfloor{(x-y)/2}\rfloor$, $P'=P\cup \{x'\}$, $I_1=I$, $I_2=I\cup \{x'\}$, $I_3=I\cup \{x,x'\}$ and $I_4=I\cup \{x\}$ then for some $i\in\cub{1,2,3}, \ \dgg{I_i}{P'}$ and $\dgg{I_{i+1}}{P'}$ are $(t, \eps/3n)$-distinguishable.
\end{itemize}
\end{lemma}

\begin{proof}
If $x=y+1$ then $\dgg{I}{P}$ and $\dgg{I\cup \{x\}}{P}$ satisfy Properties 1 and 2. Therefore we can construct distinguisher \a~that breaks  the \tcpa~security of the encryption scheme. In both games $\encrypt(p_{y-1},p_{y})$ is responded to with a fake answer $\Enc_{k_{p_{y-1}}}(r_{p_{y}})$, thus $k_{p_{y}} $ remains independent and uniform in the eyes of the adversary. On the other hand the query $\encrypt(p_{y},p_x)$ is responded to with a fake answer $\Enc_{k_{p_{y}}}(r_{p_{x}})$ in one game and with a real answer in the other game, i.e. $\Enc_{k_{p_{y}}}(k_{p_{x}})$. Therefore if $\A$ can distinguish the two games, it can distinguish between the encryption of two messages, $r_x$ and $k_x$, under a uniform and independent key, $k_y$. 

If $x>y+1$, then the $x'$th node is roughly in the middle of $y$th and $x$th node on the path. If $\dgg{I}{P}$ and $\dgg{I\cup \{x\}}{P}$ are $(t,\eps)$-distinguishable then the two games  $\dgg{I}{P'}$ and $\dgg{I\cup {x}}{P'}$ are $(t,\eps/n)$-distinguishable, since the guess for the $x'$th node is correct with probability 1/n. Therefore we have
\begin{align}
\dElta{\dgg{I_1}{P'}, \dgg{I_2}{P'}} + \dElta{\dgg{I_2}{P'}, \dgg{I_3}{P'}} + \dElta{\dgg{I_3}{P'}, \dgg{I_4}{P'}}  \geq \nonumber\\ \dElta{\dgg{I_1}{P'}, \dgg{I_4}{P'}}  > \nonumber \\ \eps/n.
\end{align}

Finally, at least one of the above pairs of games is $(t,\eps/3n)$-distinguishable. \\
\end{proof}
\fi
Applying Lemma \ref{lem:single} repeatedly for $\log(n)$ times, we get the proof of Theorem \ref{thm:s1in-1out}.\\


\textbf{Multiple outgoing edges.} Next we analyze the case where we allow $\A$ to ask for encryption of multiple keys under the same unifrom key, (e.g. $\encrypt(y,x_1), \encrypt(y,x_2), \cdots.)$. Whereas the attacker still cannot ask for the encryption of a single key under two different keys. For instance $\encrypt(y_1,x)$ and $ \encrypt(y_2,x)$ cannot be queried in one game. Intuitively, since $(\Enc,\Dec)$ is secure against chosen plaintext attacks, asking for encryption of other messages under the same uniform key should not help the adversary to break the scheme. 

\begin{theorem}\label{thm:1in-Mout}
Let $t \in \mathbb{N}$, $0<\eps<1$ and $\G_2$ a class of directed trees of $n$ nodes where indegree of any node is at most 1. If an encryption scheme is \tcpa~secure, then it is also $(t',\eps',\G_2)$-GSD secure for $\eps'=(3n)^{\log n} \eps$ and $t'=t-O(Time(\Enc))$.
\end{theorem}

\begin{proof}
First we describe the chosen plaintext attack in more details. The game between distinguisher \a~and challenger \ch, is as follows: \ch~chooses a uniformly random key $k$ and a bit $b$. \a~can send queries of form $(m_0,m_1)$ to \ch, and receives $c\leftarrow \Enc_k(m_b)$ from \ch. To receive the encryption of a specific message $m$, \a~can query $(m,m)$. \a~is not allowed to query the same message in two different queries. In the end, \a~will output a bit in $\tilde{b}\in \zo$. The encryption scheme is secure if for any $t$-bounded distinguisher \a, $\abs{\prob{\mathcal{D}_t^{\mathcal{C}[k,b]}=1|b=0} - \prob{\mathcal{D}_t^{\mathcal{C}[k,b]}=1|b=1} }< \eps.$

 In this $GSD$ game the $G(\A)$ is a tree in which every node has indegree at most 1 but can have outdegree more than 1. Notice there is still only one path to the challenge node. Thus we can use the same method we used before: we guess the path to the challenge node gradually in a series of games and find the two games $\dgame$ and $\dgame'$ with the same properties as before. Let $\encrypt(y,z)$ be the query that is replied to differently in the two games and $\encrypt(x,y)$ be the query which is replied with a fake answer in both games. We try to construct a distinguisher \a~to break the \tcpa~security of the encryption scheme. The only difference is that now $\A$ can ask for encryption of other messages under the same key $k_y$. However, \a~is also allowed to ask for the encryption of different message under the uniform key. Therefore if there is a player $\A$ distinguishing between the two games $\dgame$ and $\dgame'$, \a~can simulate $\dgame$ on its own, by playing the part of player \B. When $\A$ queries $\encrypt(y,z)$, \a~sends $(k_z,r_z)$ to the challenger \ch~and sends the response $c$ from \ch~back to $\A$. Similarly, if $\A$ queries $\encrypt(y,z')$, \a~sends $(k_{z'},k_{z'})$ to \ch~and sends the response from \ch~to $\A$. This way, if \ch~has chosen $b=0$ then the game \a~is simulating is $\dgame$, with the real response to query $\encrypt(y,z)$, and if $b=1$ then the game is $\dgame'$, and if $\A$ can distinguish them then \a~can win the CPA game with the same advantage.
\end{proof}

\section{Multiple paths}

In this section we study a more complicated case, where the graph can have multiple paths to the same challenge node. Similar to the last section, we first consider the case where every node has outdegree at most 1 and then the case where nodes can have outdegree more than 1.

\subsection{Single outgoing edge.}
Every key in the game is selected independently from each other and are only related if they are queried by $\A$, and are part of the same connected component of the graph $G(\A)$. Accordingly we can only focus on the connected component of the graph that includes the challenge node. Thus in this case, we assume $G(\A)$ is a tree with nodes of outdegree at most 1. This means every node in the graph is on a path to the challenge. \\

\begin{theorem}\label{thm:Min-1out}
Let $t \in \mathbb{N}$, $0<\eps<1$ and $\G_3$  be a class of directed trees of $n$ nodes where outdegree of any node is at most 1. If an encryption scheme is \tcpa~secure, then it is also $(t',\eps',\G_3)$-GSD secure for $\eps'=n\cdot ((2n+1)\cdot n)^{\log n} \cdot \eps$ and $t'=t-O(Time(\Enc))$.
\end{theorem}

%  \textbf{The naive approach.} %Interestingly the naive approach is the same as for the case of the single path. \\

  \textbf{Our approach.}
The idea is the same as before: to find two games $\dgame$ and $\dgame'$ which are $(t,\eps)$-distinguishable if $\game_{\emptyset}$ and $\game_{\{n\}}$ are $(t',\eps')$-distinguishable, and have the two essential properties. Property 1, the two games differ in exactly one query, $\encrypt(y,x)$ . Property 2, all the queries asking for encryption $k_y$ are replied with a fake response, as to keep $k_y$ independent of all the other queries. Once again we define hybrid games differing in only one query, for which we need to first guess a node in the game to be able to describe where the two games are different. Furthermore now we need to guess which ingoing edge (query) is  going to be different. Before we chose the middle node on the path as the node  we would like to find. The reason for that was to reduce the problem, to smaller problems (i.e. to find the half of the path containing a distinguishable step). Here we need a new metric since there are multiple paths. We try to reduce the number of paths in a distinguishable tree. We guess a node $v$ such that (nearly) half of the paths to the challenge node go through $v$. Either the subtree ending in $v$ is distinguishable or the rest of the original tree,  or both! Regardless we can recurse on one distinguishable subtree trying to halve the number of paths to the (now) sink node in that subtree. Until there is only one path left, where we can apply the same method used in the last section to find the distinguishable edge. \\

  \textbf{More notation.} For every node $x\in [n]$, let $\T_x$ be the graph of all the paths in $G(\A)$ that reach $x$. Considering every tree as the set of its edges, we define the following operations on trees: for two trees $\T_1$ and $\T_2$, we define $\T_1-\T_2$ be the graph obtained from $\T_1$ after removing edges in $\T_2$ (i.e., $ \T_1\setminus \T_2 $) and $\T_1+\T_2 = \T_1\cup \T_2$.  We call a node with indegree 0, a source and $S(v)$ is the number of sources in the tree $\T_v$.  Let $\T$ be a tree with at least 2 sources, we say a node $v$ in the tree $\T$ \textit{well-divides} the tree if the number of sources in each subtree after removing node $v$ and all its edges, is less than or equal to half of the sources in the original tree. If $\T$ has only one source, then $v$ well-divides $\T$ if the number of nodes in each subtree after removing $v$ is less than or equal to half of the nodes in the original tree. Note that number of paths to a node $v$ is the same as number of sources in $\T_v$. For a node $x$ we call any node $y$ in the graph with an edge into $x$, ($(y,x)\in \T$), and in-neighbor of $x$ and similarly $x$ is the out-neighbor of $y$.\\
  

  Recall that the graph $G(\A)$ is a tree, and every node in $G(\A)$ is on a path to the challenge. Once more we define games \gpi, where $P$ is the set that determines the nodes in the graph that are going to be guessed and $I$ is the set that determines which of the queries involving the guessed nodes are going to be replied with a fake answer. At the end of the game, if all the guesses are correct, the output of the game is $\A$'s output and otherwise it is 0.\\
\begin{boxfig}{Hybrid games}{compose}
For $m\leq \log (n)$
\begin{itemize}
  \item $P=\cub {(i,s)\ | i \in \cub{0,1,\cdots,m}, s\in [n]} $.
  \item $I=\cub {(i,f)\ | i \in \cub{0,1,\cdots,m}, f\in \zo}$. If $(i,n)\in P$ then $(i,0) \in I$. 
  \item In \gpi, player $\B$ guesses $m+1$ nodes, $v_0,v_1,\cdots,v_m$. For each guessed node $v_i$, $\B$ will return fake responses to the first $s-1+f$ queries $\encrypt(*,v_i)$ and real responses to the rest of such queries. At the end of the game player $\A$ outputs bit $b\in \zo$.
 \item $\bigt{0}=\T$ and $\bigtb{0}=\emptyset$. For $(i,s)\in P$ and $i\geq 0$, if $s<n$ then $\bigtb{i+1}=\bigtb{i}x$ and $\bigt{i+1}=\T_{\bigv{s}}-\bigtb{i+1}.$ If $s=n$ then $\bigtb{i+1}=\bigtb{i}+\T_{\bigv{i}},$ and $\bigt{i+1}=\bigt{i}- \bigtb{i+1}.$
\item If $v_0$ is the challenge node and for $i>0$, $v_i$ well-divides $\bigt{i}$ which are defined as follows. \gpi=b, otherwise \gpi=0. 
\end{itemize}
\end{boxfig}

  \textbf{Set $P$ and the check.} When the interaction with $\A$ is over, we first need to check and see if the guesses were made correctly. As before we start by checking if the challenge node (here called $v_0$) was guessed correctly. Although checking of the rest of guesses is not as easy as it was before. For any new element added to the guessed set $P$, a correctly guessed node needs to \textit{well-divide} some specific subtree. For instance, the guessed node $v_1$ (the first node guessed after the challenge node) is a good guess if roughly half the paths to the challenge node go through $v_1$. However for $v_2$, the next guessed node, we need to know if we were supposed to guess a node in the bottom subtree, $\T_{v_0}-\T_{v_1}$ or the upper subtree, $\T_{v_1}$. Furthermore if $\T_{v_1}$ is chosen, we also need to choose a specific branch of it, since $v_1$ might have multiple in-neighbors and we need to continue with only one of them. So $P$ is a subset of elements of the form $(i,s), i\in [n]_0$ and $s \in [n]$. The index $i$ is simply for ordering the list, (for each $i$, $v_i$ is the $i$th guessed node after the challenge node.) and $s$ specifies which subtree the next guessed node is going to be in. If $s=n$ then the next node is in the lower subtree. If $s\leq d$, where $d$ is the indegree of $v_i$, then the next guessed node must be in tree $\T_{\bigv{s} }$ where $\bigv{s}$ is the $s$th in-neighbor of $v_i$. If $d<s<n$ we play the game as if $s=d$. More precisely, for $(i,s)\in P$ and $i>0$, we define the distinguishable subtree $\bigt{i}$ a follows, 
  \begin{align*}
&\text{if } s<n, \qquad \bigtb{i+1}=\bigtb{i}, \text{ and }\bigt{i+1}=\T_{\bigv{s}}-\bigtb{i+1}, \\
&\text{if } s=n, \qquad \bigtb{i+1}=\bigtb{i}+\T_{\bigv{i}}, \text{ and }\bigt{i+1}=\bigt{i}- \bigtb{i+1}, 
  \end{align*}

 and set $\bigt{0}=\T$ and $\bigtb{0}=\emptyset$. At each step $i$, $v_i$ is a good guess if it well-divides subtree $\bigt{i}$. $\bigtb{i}$ is the set of edges that have already been removed from the distinguishable subtree. The check passes if all the guesses are good. When $\bigt{i}$ is a single node, we need to guess that single node and we stop checking the rest of the guessed nodes if any exists. We later show that a well-dividing node always exists by giving a simple algorithm to find one in any tree. Thus for any new element $(i,s)$ added to $P$ there is at least one node in the tree which is a good guess for $v_i$ and consequently $\prob{\game_{I}^{P\cup (i,s) }=1}\geq \prob{\dgg{I}{P}=1}/n$. Therefore if two games $ \dgg{I}{P}$ and $\dgg{I'}{P}$ are $(t,\eps)$-distinguishable then $ \game_{I}^{P\cup (i,s) }$ and $\game_{I'}^{P\cup (i,s)}$ are $(t,\eps/n)$-distinguishable. Furthermore, notice that every time a new node is guessed, the number of sources in the distinguishable subtree is reduced to at least half of what it was before, we continue this process until  there is only one source left. At this point we use the same method we used in the last section to reduce the size of this single path to half, at each guessing step. \\

  \textbf{Set $I$ and the hybrid games.} In the last section, $I$ was a subset of $P$ and for every element $x$ in $I$ the $\encrypt(*,x)$ query was responded with a fake answer. Unlike before, here we can have multiple queries of form $\encrypt(*,x)$, therefore $I$ needs to determine which queries are fake for each node in $P$. To do so, for every element $(i,s)\in P$, for $0<s<n$ there is an element $(i,f)\in I$, for some $f\in\zo$. If $(i,n)\in P$ then $(i,0)\in I$. If $f=1$, the first $s$th queries of form $\encrypt(*,v_i)$ are responded with fake answers and the rest of queries are responded with real ones. If $s=0$ then the first $s-1$ queries are replied to with fake responses. If $d<s<n$ where $d$ is the indegree of $v_i$ then all responses are fake (recall that we play the game as if $s=d$.)
  
%\begin{align*}
%\T_*=\left\{ \begin{array}{l l}
%\T_{\bigw}-\T_{\bigv{i-1}},&\text{if } (i-1,down) \in P,(\lastup_i,j,f)\in I\\& \text{ and }\bigw \text{ is the $( j+f)$th node with an edge into } \bigv{\lastup_i}\\
%\T_{\bigw}-\T{\bigv{\lastdown_i}},&\text{if }(i-1,up)\in P,(i-1,j,f)\in I \text{ and }\bigw \text{ is the $(j+f)$th node with an edge into }  \bigv{i-1} \end{array}\right.
%\end{align*} 

Previously for each new element $z$ added to $P$, and for any game \gpi, we defined two new hybrid games, one with a fake response and one with a real response to the query $\encrypt(*,z)$. Thus for any pair of games $\dgg{I}{P}$ and $\dgg{I'}{P}$, with $\abs{I \triangle I'}=1$, we ended up with 4 games which built up 3 pairs of games satisfying property 1. Here, for a new guessed node $v_i$, we need to define many new games, one for each combination of $P\cup (i,s)$ for $s\in\cub{1,2,\cdots,n}$ and $I\cup(i,f), \ f\in\zo$ (except for $P\cup (i,n)$ and $I \cup (i,1)$). It appears that we have defined $2n-1$ new games but note that two games $\dgg {I\cup (i,1)}{P\cup(i,s-1)}$ and $\dgg {I\cup (i,0)}{P\cup(i,s)}$ are actually the same game: In both game the first $s$th queries of form $\encrypt(*,v_i)$ are replied to with fake answers (for $s<n$). What would have separated these games is the node to be guessed after the $i$th step, but since the two games end here, they are identical. Thus we have defined $n$ new games $\dgg {I\cup (i,0)}{P\cup(i,s)}$ for $s\in [n]$. %to once add $(i,up) $ to $P$ and once add $(i,down)$. First consider the case we add $(i,up)$ to $P$. For each game \gpi~ we define $2d$ hybrid games, where $d$ is the indegree of $v_i$. Because we get a new game for each possible value for $j\in[d]_0$ and $f\in\zo$ in $(i,j,f)$. Except for the two values $(i,0,0)$ and $(i,d,1)$, which will give us invalid games. The value of $f$ determines whether the $j$th node with an ingoing edge into the $i$th guessed node is going be part of the distinguishable tree in the next step or not. That is why it is necessary to know $f$ before we are able to precisely define tree $\T_*$. If $f$ is $0$, it means that the next guessed node must be in the subtree that ends with the $j$th neighbor if $v_i$. If $f=1$, then the next guessed node must be in the subtree the ends with the $j+1$st neighbor of $v_i$. And that is why $(i,0,0)$ and $(i,d,1)$ are not valid values. 
%Note that although the two games $\dgg{I\cup(i,j,0)}{P\cup(i,up)}$ and $\dgg{I\cup(i,j,1)}{P\cup(i,up)}$ are defined differently, we have the following property,
%$$ \prob{\dgg{I\cup(i,j,0)}{P}=1}= \prob{\dgg{I\cup(i,j,1)}{P}=1}.$$
%Since in both games we need to guess the same number of nodes and the same queries are replied with fake answers. 
As a result, for any pair of games $\dgg{I}{P}$ and $\dgg{I'}{P}$, such that $I$ and $I'$ are identical except for one element $(j,0)\in I$ and $(j,1)\in I'$ we end up with at most $2(d+1)$ new hybrid games of form $\dgg{\tilde{I}}{P\cup (i,s)}$, for $\tilde{I}=I\cup (i,0)$ and $\tilde{I}=I'\cup (i,0)$ and $s\in [d]\cup \cub{n}$. Therefore we get $2d-1$ pairs of games that satisfy Property 1. 
\begin{align*}
\rob{\dgg{I\cup (i,0)}{P\cup (i,s+1)},\dgg{I\cup (i,0)}{P\cup (i,s)} }\text{ for } 1\leq s \leq d,  \\ 
\rob{\dgg{I'\cup (i,0)}{P\cup (i,s+1)},\dgg{I'\cup (i,0)}{P\cup (i,s)}} \text{ for } 1\leq s \leq d.  \\
\rob{\dgg{I\cup (i,0)}{P\cup (i,n)},\dgg{I'\cup (i,0)}{P\cup (i,n)}}.
\end{align*}
However we do not know the indegree of $v_i$. We simply consider the maximum value for $d$ which is $n-1$. Finally, one of the pairs of games satisfying property 1, must be $\eps/n(2n-1)$- distinguishable if $\dgg{I}{P}$ and $\dgg{I'}{P}$ are $\eps$- distinguishable.  If the pair $\rob{\dgg{I\cup (i,0)}{P\cup (i,s+1)},\dgg{I\cup (i,0)}{P\cup (i,s)} }$ is $\eps/n(2n-1)$-distinguishable then we can use the equivalent pair $\rob{\dgg{I\cup (i,1)}{P\cup (i,s)},\dgg{I\cup (i,0)}{P\cup (i,s)} }$ to continue to the next step.\\

  \textbf{Finding a well-dividing node}.
Let $S(x)$ denote the number of sources in the subtree $\T_x$ and let $x_1, \cdots x_d$  be the nodes with an outgoing edge $(x_i,x)$. As long as $S(x)\geq 2$, the following algorithm will output a node $x_*$ in tree $\T_x$ such that  all the subtrees obtained from removing $x_*$ from $\T_x$ have less than or equal to half of the sources in $\T_x$.

\hspace{2mm}
\begin{algorithmic}
\State Well-Dividing Node$(\T,x)$
\State $\ell \gets 0$ 
\State $d_{\T}=S(x)$
\State{{\sf found$\gets$false}}
\While {{\sf found=false}}
	\If {$\exists i,S(x_i)>d_{\T}/2$}
 	   \State $\ell\gets d_{\T}-S(x_i)$ 
 	   \State $x \gets x_i$
	\Else
  	  \State{{\sf found$\gets$true}}
	\EndIf
\EndWhile
\State output $x$
\end{algorithmic}
\hspace{1mm}

The algorithm starts from the sink of the tree and it traverses the tree up until it finds a well-dividing node. In each iteration, the variable $\ell$ keeps track of the number of sources in the subtree $\T-\T_x$, where $x$ is the node at hand and $\T$ is the original tree. In other words, at each iteration of the \textbf{while} loop, $\ell + S(x)$ is the total number of sources in the tree. Note that at most one of the in-neighbors of $x$ can satisfy the predicate of the \textbf{if} statement and if such neighbor exists then that node has more than half of the sources of the entire tree, so we update $\ell$ and $x$ accordingly and search for the well-dividing node in the new $\T_x$. On the other hand, if no such an in-neighbor exists, it means that after removing $x$ from the tree all the subtrees ending in one of the in-neighbors of $x$ have less sources than half of the sources of the entire tree. Also note that $\ell$ is never greater than $d_{\T}/2$, since $\ell$ is changed only when $S(x_i)>d_{\T}/2$. Therefore the tree $\T-\T_x$ has less than $d_{\T}/2$ sources as well, meaning $x$ is the well-dividing node.

%Let us assume we know that the graph $G(\A)$ has at most $w$ sources. When $P$ has $\log w$ 

\begin{lemma}\label{lem:multiple}
For $0\leq i_*\leq m \leq 2\log n$, let  $$ P=\cub{(i,s)| 0\leq i < i_*, s\in [n]}\cup \cub{(i,n)| i_*< i \leq m} \cup \cub{(i_*,s_*)| s_*\in[n-1]}.$$ and let $ I=\cub{(i,f)| \ 0\leq i \leq m,\ f\in\zo}$ and $ I'$ identical to $ I$ except for the $i_*$th element; $(i_*,0)\in  I$ and $(i_*,1) \in I'$. If $\dgg{ I}{ P}$ and $\dgg{I'}{ P}$ are $(t,\eps)$-distinguishable then

\begin{itemize}
\item if $m=2\log n$ then, $(\Enc,\Dec)$ is not $(t, \eps)$-Ind-CPA-secure.
\item Otherwise, 
 at least one of the following pairs of games is $(t,\eps/n(2n-1))$-distinguishable

\begin{itemize}
\item $\dgg{ I\cup (m+1,0)}{ P\cup \cub{(m+1, n)}}$ and $\dgg{I'\cup (m+1,0)}{ P\cup \cub{(m+1, n)}}$,
\item $\dgg{ I\cup (m+1,0)}{ P\cup \cub{(m+1, s)}}$ and $\dgg{ I\cup (m+1,0)}{ P\cup \cub{(m+1, s)}}$, for some  $1\leq s< n$,
\item $\dgg{I'\cup (m+1,0)}{ P\cup \cub{(m+1, s)}}$ and $\dgg{I'\cup (m+1,0)}{ P\cup \cub{(m+1, s)}}$, for some  $1\leq s < n$
\end{itemize}
 \end{itemize}
\end{lemma}

\begin{proof}
According to $ P$, $ I$ and $ I'$, the two games only differ in the response to $s_*$th $\encrypt$ query of form $\encrypt(\bigv{s_*},\bigv{i_*})$ for some $\bigv{s_*}\in[n]$. We add another element to $P$. The $m+1$st guessed node must well-divide subtree $\T:=\T_{\bigv{s_*}}- \sum_{\forall (j,n)\in  P}\T_{\bigv{j}}$ in both games. If such a node exists, the probability of guessing the node correctly is $1/n$, thus $\dgg{ I\cup (m+1,0)}{P \cup(m+1,1)}$ and $\dgg{I'\cup (m+1,0) }{P\cup(m+1,1)}$ are $(t,\eps/n)$-distinguishable.


\begin{align*}
\sum_{s=1}^{n-1} \dElta{\dgg{ I\cup\cub{ (m+1,0)}}{ P\cup \cub{(m+1, s)}},\dgg{ I\cup\cub{ (m+1,0)}}{ P\cup \cub{(m+1, s+1)}}}+ \dElta{\dgg{ I\cup\cub{ (m+1,0)}}{ P\cup \cub{(m+1, n)}},\dgg{I'\cup \cub{(m+1,0)}}{ P\cup \cub{(m+1, n)}}} \\+ \sum_{s=1}^{n-1} \dElta{\dgg{I'\cup \cub{(m+1,0)}}{ P\cup \cub{(m+1, n-s-1)}},\dgg{I'\cup\cub{ (m+1,0)}}{ P\cup \cub{(m+1, n-s)}}}
> \dElta{\dgg{ I\cup \cub{(m+1,0)}}{P_{m}\cup \cub{(m+1,1)}},\dgg{I'\cup\cub{ (m+1,0) }}{P_{m}\cup \cub{(m+1,1)}}}\\ \geq \eps/n.
\end{align*}

Consequently at least one of the $2n-1$ pairs of games, on the left hand side of the inequality above, must be $(t,\eps/n(2n-1))$-distinguishable. On the other hand, if no well-dividing node exists in subtree $\T_*$, it means that $\bigv{s_*}$ is itself guessed at some point after the $i_*$ step. This implies that all the queries of form $\encrypt(x,\bigv{s_*})$ have been replied to with fake responses, $c\leftarrow \Enc_{k_x}(r_{\bigv{s_*}})$, leaving $\bigv{s_*}$ uniformly random to $\A$. 

In this case, $(t,\eps)$-distinguishability of $\dgg{ I}{ P}$ and $\dgg{I'}{ P}$ implies that $(\Enc,\Dec)$ is not \tcpa~secure, since the player $\A$ who can distinguish $\dgg{ I}{ P}$ and $\dgg{I'}{ P}$ can distinguish the encryption of two different messages, $k_{\bigv{i_*}}$ and $r_{\bigv{i_*}}$ under the uniform key $k_{\bigv{s_*}}$. 
We construct distinguisher \a~as follows: \a~plays $\dgg{ I}{ P},$ as player $\B$. Once $\A$ queries $\encrypt(\bigv{s_*},\bigv{i_*})$, \a~makes the query $\rob{k_{\bigv{i_*}},r_{\bigv{i_*}}}$ to challenger \ch~and receives $c_0= \Enc_k(k_{\bigv{i_*}})$ or $c_1= \Enc_k(r_{\bigv{i_*}})$ for a uniformly random key $k$. \a~sends $c_b, b\in\zo$ to $\A$. If $b=0$, then the game is $\dgg{ I}{ P}$ and if $b=1$, $\dgg{I'}{ P}$. Therefore if $\A$ distinguishes the two games with advantage $\eps$ then \a~can output $b$ correctly with advantage $\eps$ as well.

\def\src{{\sf src}}
\def\nsr{{\sf nsr}}

If $G(\A)$ has \src~sources and \nsr=$n-$\src. Then clearly after $\log(\mathsf{src})$ there is at most one source left in the distinguishable subtree. And after $\log(\mathsf{nsr})$ steps the distinguishable subtree is a single node, which will be guessed if there is another guessing step. In the end after $2\log(n)$ steps, there cannot be any more nodes left in the distinguishable subtree to be guessed and there for by the same reasoning stated above, the distinguishability of the two games implies that the encryption scheme is not Ind-CPA secure.
\end{proof}




\end{document}